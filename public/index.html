<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fresh Mart - Online Store</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0fb9b1">
    <link rel="apple-touch-icon" href="logo.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* --- CORE STYLES --- */
        :root {
            /* üî• Unique "Ocean Fresh" Palette */
            --primary: #0fb9b1;  /* Vibrant Turquoise */
            --dark: #2d3436;     /* Midnight Grey */
            --light: #f1f2f6;    /* Soft Cloud White */
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(15, 185, 177, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(180deg, #f1f2f6 0%, #ffffff 100%); 
            color: var(--dark); 
            margin: 0; 
            padding-bottom: 100px; 
            overflow-x: hidden;
        }

        /* --- HEADER (Fixed Alignment) --- */
        header { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            padding: 12px 5%; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.04); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid rgba(15, 185, 177, 0.1); 
        }

        .logo { 
            font-size: 20px; 
            font-weight: 800; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .version-tag { 
            font-family: 'Courier Prime', monospace; 
            font-size: 10px; 
            background: #e0fbfb; 
            color: var(--primary); 
            padding: 2px 6px; 
            border-radius: 4px; 
            border: 1px solid rgba(15, 185, 177, 0.2); 
        }
        
        .nav-icons { display: flex; gap: 12px; align-items: center; }
        
        .icon-btn { 
            font-size: 20px; 
            color: var(--dark); 
            cursor: pointer; 
            position: relative; 
            transition: 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 38px; 
            height: 38px; 
            border-radius: 50%; 
            background: #f1f2f6;
        }
        .icon-btn:active { transform: scale(0.95); background: #e0fbfb; }
        
        .badge { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            background: var(--primary); 
            color: white; 
            font-size: 10px; 
            height: 18px; 
            min-width: 18px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            font-weight: bold; 
            border: 2px solid white; 
            display: none; 
        }

        .admin-link {
            text-decoration: none; 
            color: var(--dark); 
            font-size: 11px; 
            font-weight: 700; 
            background: #f1f2f6; 
            padding: 8px 12px; 
            border-radius: 20px;
            transition: 0.2s;
        }

        /* HERO SECTION */
        .hero { 
            background: linear-gradient(135deg, #0fb9b1, #2bcbba); 
            padding: 25px 20px; 
            border-radius: 0 0 30px 30px; 
            color: white; 
            text-align: center; 
            margin-bottom: 20px; 
            box-shadow: 0 10px 25px rgba(15, 185, 177, 0.4); 
        }
        .hero h1 { font-size: 26px; font-weight: 800; margin-bottom: 5px; text-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .hero p { font-size: 14px; opacity: 0.95; font-weight: 400; }

        /* CONTROLS & SEARCH */
        .controls { padding: 0 5%; margin-bottom: 20px; }
        .search-box { width: 100%; padding: 14px 20px; border: none; border-radius: 15px; font-size: 15px; margin-bottom: 15px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); font-weight: 600; outline: none; transition: 0.3s; color: var(--dark); }
        .search-box:focus { box-shadow: 0 5px 20px rgba(15, 185, 177, 0.15); }
        
        .filters { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .filter-btn { white-space: nowrap; padding: 8px 16px; border: none; background: white; border-radius: 25px; cursor: pointer; font-weight: 600; color: #636e72; box-shadow: 0 3px 10px rgba(0,0,0,0.05); transition: 0.3s; font-size: 13px; border: 1px solid transparent; }
        .filter-btn.active { background: var(--primary); color: white; transform: scale(1.05); box-shadow: 0 5px 15px rgba(15, 185, 177, 0.3); }

        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 0 5%; }
        .food-card { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.03); transition: 0.3s; border: 1px solid rgba(0,0,0,0.02); position: relative; }
        .food-card:active { transform: scale(0.96); }
        
        .food-card.sold-out { opacity: 0.6; filter: grayscale(1); pointer-events: none; }
        .food-card.sold-out::after { content: "SOLD OUT"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); background: var(--dark); color: white; padding: 6px 12px; font-weight: 800; border-radius: 6px; font-size: 13px; z-index: 2; }
        
        .bestseller-badge { position: absolute; top: 10px; left: 10px; background: rgba(255, 71, 87, 0.9); backdrop-filter: blur(4px); color: white; font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10; text-transform: uppercase; }

        .food-img { width: 100%; height: 140px; object-fit: cover; }
        .food-info { padding: 12px; }
        .food-name { font-size: 15px; font-weight: 700; margin-bottom: 4px; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .food-cat { font-size: 10px; color: #b2bec3; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .food-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        
        .price { font-size: 16px; font-weight: 800; color: #eb4d4b; } 
        
        .add-btn { background: white; border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .add-btn:active { background: var(--primary); color: white; }

        /* SIDEBARS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 998; display: none; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s; }
        .overlay.active { display: block; opacity: 1; }
        .sidebar { position: fixed; top: 0; width: 85%; max-width: 400px; height: 100%; background: white; z-index: 1000; transition: transform 0.4s; display: flex; flex-direction: column; box-shadow: 0 0 40px rgba(0,0,0,0.2); }
        .history-sidebar { left: 0; transform: translateX(-105%); }
        .history-sidebar.active { transform: translateX(0); }
        .cart-sidebar { right: 0; transform: translateX(105%); }
        .cart-sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 20px 25px; background: white; display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 800; border-bottom: 1px solid #f1f2f6; color: var(--dark); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; }

        /* CART & HISTORY */
        .cart-item, .track-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid #fff; }
        .cart-item-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: 700; font-size: 15px; }
        .item-actions { display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; padding: 5px; border-radius: 10px; border: 1px solid #f1f2f6; }
        
        .pack-switch { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; cursor: pointer; user-select: none; }
        .toggle-box { width: 36px; height: 20px; background: #dfe6e9; border-radius: 20px; position: relative; transition: 0.3s; }
        .toggle-box::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .pack-checkbox:checked + .toggle-box { background: var(--primary); }
        .pack-checkbox:checked + .toggle-box::after { left: 18px; }
        .pack-checkbox { display: none; }

        .qty-controls { display: flex; align-items: center; gap: 12px; background: white; padding: 5px 12px; border-radius: 10px; border: 1px solid #eee; }
        .qty-btn { font-weight: 800; color: var(--primary); cursor: pointer; font-size: 16px; width: 20px; text-align: center; }
        
        .cart-footer { padding: 25px; background: white; border-top: 1px solid #f1f2f6; border-radius: 20px 20px 0 0; box-shadow: 0 -10px 30px rgba(0,0,0,0.03); z-index: 10; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; font-weight: 500; color: #636e72; }
        .total-row { display: flex; justify-content: space-between; font-size: 18px; font-weight: 800; color: var(--dark); margin-top: 15px; padding-top: 15px; border-top: 2px dashed #f1f2f6; }
        
        .checkout-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: 800; cursor: pointer; margin-top: 20px; box-shadow: 0 10px 25px rgba(15, 185, 177, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .checkout-btn:active { transform: scale(0.98); }
        .checkout-btn:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; }

        .time-chips { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 5px; scrollbar-width: none; }
        .time-chip { padding: 8px 14px; border-radius: 10px; background: #f1f2f6; font-weight: 700; font-size: 12px; color: var(--dark); cursor: pointer; border: 2px solid transparent; white-space: nowrap; transition: 0.2s; }
        .time-chip.active { background: #e0fbfb; border-color: var(--primary); color: var(--primary); }

        .track-status { font-size: 11px; padding: 5px 10px; border-radius: 20px; font-weight: 800; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-Pending { border-left-color: #f1c40f; } .status-Pending .track-status { background: #fff9db; color: #f39c12; }
        .status-Accepted { border-left-color: #3498db; } .status-Accepted .track-status { background: #e3f2fd; color: #2980b9; } 
        .status-Ready { border-left-color: #2ecc71; } .status-Ready .track-status { background: #e8f5e9; color: #27ae60; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 5000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 380px; text-align: center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 90vh; overflow-y: auto; }
        @keyframes popUp { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .inp-field { width: 100%; padding: 14px; margin-bottom: 12px; border: 2px solid #f1f2f6; border-radius: 12px; font-weight: 600; background: #f9f9f9; outline: none; font-size: 15px; transition: 0.3s; }
        .inp-field:focus { border-color: var(--primary); background: white; }

        /* Payment Tabs */
        .pay-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .pay-tab { flex: 1; padding: 12px; border: 2px solid #f1f2f6; border-radius: 12px; cursor: pointer; font-weight: 700; color: #b2bec3; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 12px; }
        .pay-tab i { font-size: 20px; }
        .pay-tab.active { border-color: var(--primary); background: #e0fbfb; color: var(--primary); }

        .coupon-box { display: flex; gap: 8px; margin-bottom: 15px; }
        .apply-btn { background: var(--dark); color: white; border: none; padding: 0 15px; border-radius: 10px; font-weight: 700; cursor: pointer; }

        #qr-section { display: none; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 15px; border: 1px dashed #ccc; }
        #qr-img { width: 140px; height: 140px; margin-bottom: 5px; mix-blend-mode: multiply; }

        #toast { visibility: hidden; min-width: 250px; background: #2d3436; color: #fff; text-align: center; border-radius: 50px; padding: 14px; position: fixed; z-index: 6000; left: 50%; transform: translateX(-50%); bottom: 30px; font-size: 14px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.0s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        div:where(.swal2-container) { z-index: 10000 !important; }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="closeAllSidebars()"></div>

    <header>
        <div class="logo">
            <i class="fa-solid fa-basket-shopping" style="color:var(--primary); font-size:24px;"></i> 
            FRESH MART <span class="version-tag">v8.0</span>
        </div>
        <div class="nav-icons">
            <div class="icon-btn" onclick="openSidebar('history')" title="Track Orders"><i class="fa-solid fa-clock-rotate-left"></i></div>
            <a href="admin.html" class="admin-link">ADMIN</a>
            <div class="icon-btn" onclick="openSidebar('cart')">
                <i class="fa-solid fa-bag-shopping"></i>
                <span class="badge" id="cart-count">0</span>
            </div>
        </div>
    </header>

    <section class="hero">
        <h1 style="font-size: 26px; text-shadow: 0 2px 5px rgba(0,0,0,0.1);">Fresh & Fast ‚ö°</h1>
        <p style="opacity: 0.9;">Superfast Grocery Delivery</p>
    </section>

    <div class="app-banner" id="installBanner">
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="logo.png" style="height:40px; border-radius:10px; background:white;">
            <div>
                <div style="font-weight: 800; font-size: 14px;">Install App üì≤</div>
                <div style="font-size: 11px; opacity: 0.8;">Better Experience</div>
            </div>
        </div>
        <button class="app-btn" id="installBtn">INSTALL</button>
    </div>

    <section class="controls">
        <input type="text" class="search-box" placeholder="üîç Search Items..." onkeyup="filterMenu(this.value)">
        <div class="filters">
            <button class="filter-btn active" onclick="filterCat('All')">All</button>
            <button class="filter-btn" onclick="filterCat('Munchies')">üç™ Munchies</button>
            <button class="filter-btn" onclick="filterCat('Beverages')">ü•§ Drinks</button>
            <button class="filter-btn" onclick="filterCat('FruitsVeg')">ü•¶ Fresh</button>
            <button class="filter-btn" onclick="filterCat('Electronics')">üéß Electronics</button>
            <button class="filter-btn" onclick="filterCat('DairyBread')">ü•õ Dairy</button>
            <button class="filter-btn" onclick="filterCat('Pharma')">üíä Pharma</button>
            <button class="filter-btn" onclick="filterCat('PersonalCare')">üöø Care</button>
            <button class="filter-btn" onclick="filterCat('HomeNeeds')">üè† Home</button>
        </div>
    </section>

    <section class="menu-grid" id="menu-container"></section>

    <div class="sidebar history-sidebar" id="historySidebar">
        <div class="sidebar-header">
            <span>üìú Track Orders</span> 
            <i class="fa-solid fa-xmark" onclick="closeAllSidebars()" style="cursor:pointer; background:#f1f2f6; padding:8px; border-radius:50%;"></i>
        </div>
        <div class="sidebar-content" id="history-list">
            <div style="text-align:center; margin-top:50px; opacity:0.5;">No active orders</div>
        </div>
    </div>

    <div class="sidebar cart-sidebar" id="cartSidebar">
        <div class="sidebar-header">
            <span>üõí My Cart</span> 
            <i class="fa-solid fa-xmark" onclick="closeAllSidebars()" style="cursor:pointer; background:#f1f2f6; padding:8px; border-radius:50%;"></i>
        </div>
        <div class="sidebar-content" id="cart-items-list">
            <div style="text-align:center; margin-top:50px; opacity:0.5;"><p>Cart is Empty</p></div>
        </div>
        <div class="cart-footer">
            <div class="time-chips" id="time-chips">
                <div class="time-chip active" onclick="selectTime(this, 'ASAP')">‚ö° ASAP</div>
                <div class="time-chip" onclick="selectTime(this, '15 Mins')">15 Min</div>
                <div class="time-chip" onclick="selectTime(this, '30 Mins')">30 Min</div>
                <div class="time-chip" onclick="selectTime(this, 'Schedule')">üìÖ Plan</div>
            </div>
            <input type="time" id="custom-time" style="display:none; margin-bottom:15px; width:100%; border:1px solid #ddd; padding:10px; border-radius:10px;">

            <div class="bill-row"><span>Total</span> <span>‚Çπ<span id="sub-total">0</span></span></div>
            <div class="total-row"><span>To Pay</span> <span>‚Çπ<span id="final-total">0</span></span></div>
            <button class="checkout-btn" id="payBtn" onclick="openPayment()">PROCEED TO PAY <i class="fa-solid fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:5px;">Total: ‚Çπ<span id="pay-amount">0</span></h2>
            <div style="font-size:12px; color:#888; margin-bottom:15px;">Complete your order</div>

            <div class="pay-tabs">
                <div class="pay-tab active" id="tab-cod" onclick="selectPaymentMode('COD')">
                    <i class="fa-solid fa-money-bill-wave"></i> Cash / Counter
                </div>
                <div class="pay-tab" id="tab-online" onclick="selectPaymentMode('Online')">
                    <i class="fa-solid fa-qrcode"></i> Pay Online
                </div>
            </div>

            <div id="qr-section">
                <img id="qr-img" src="" alt="QR Code">
                <div style="font-size:11px; color:#666;">Scan to Pay <b>‚Çπ<span id="qr-amt">0</span></b></div>
                <div style="font-size:10px; color:#999; margin-top:5px;">UPI: jainsambhav877@oksbi</div>
            </div>

            <input type="text" class="inp-field" id="student-name" placeholder="Enter Your Name">
            <input type="tel" class="inp-field" id="student-phone" placeholder="Mobile Number">

            <div class="coupon-box">
                <input type="text" class="inp-field" id="coupon-code" placeholder="Coupon Code" style="margin-bottom:0;">
                <button class="apply-btn" onclick="applyCoupon()">Apply</button>
            </div>
            <div id="coupon-msg" style="font-size:11px; margin-bottom:15px; text-align:left; display:none;"></div>

            <label style="font-size:12px; font-weight:bold; color:#555; margin-top:5px; display:block; text-align:left;">Delivery Location:</label>
            <div style="display:flex; gap:8px; margin-bottom:15px;">
                <input type="text" class="inp-field" id="delivery-location" placeholder="Eg: House No, Area..." style="margin-bottom:0; flex:1;">
                <button onclick="getGPSLocation()" id="gps-btn" style="width:50px; background:#e3f2fd; color:#0984e3; border:1px solid #0984e3; border-radius:12px; cursor:pointer; font-size:18px;">
                    <i class="fa-solid fa-location-crosshairs"></i>
                </button>
            </div>

            <div style="display:flex; gap:12px; margin-top:10px;">
                <button onclick="document.getElementById('paymentModal').style.display='none'" style="flex:1; padding:14px; background:#f1f2f6; border:none; border-radius:12px; font-weight:bold; cursor:pointer; color:#636e72;">Cancel</button>
                <button onclick="verifyAndOrder()" style="flex:1; padding:14px; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">Confirm Order</button>
            </div>
        </div>
    </div>

    <div id="toast">Item Added</div>

    <script>
        // --- PWA LOGIC ---
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); 
            deferredPrompt = e; 
            installBanner.style.display = 'flex'; 
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt(); 
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') { installBanner.style.display = 'none'; }
                deferredPrompt = null;
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch((err) => console.log('SW Failed', err));
        }

        // --- MENU & CART LOGIC ---
        let menuItems = []; 
        let cart = {};
        let isShopOpen = true;
        let selectedTime = "ASAP";
        let paymentMode = "COD";
        let currentTotal = 0;
        let appliedCoupon = null;
        let discountAmount = 0;

        window.onload = async () => {
            await fetchMenu();
            checkShopStatus();
            
            if(localStorage.getItem('savedName')) {
                document.getElementById('student-name').value = localStorage.getItem('savedName');
            }
            if(localStorage.getItem('savedPhone')) {
                document.getElementById('student-phone').value = localStorage.getItem('savedPhone');
            }
            renderHistory();
            setInterval(checkShopStatus, 3000);
        };

        async function fetchMenu() {
            try {
                const res = await fetch('/api/menu');
                menuItems = await res.json();
                renderMenu(menuItems);
            } catch(e) { console.log("Menu Load Error"); }
        }

        function renderMenu(items) {
            const container = document.getElementById('menu-container');
            if(items.length === 0) { container.innerHTML = "<p style='text-align:center;width:100%; color:#888;'>Loading Menu...</p>"; return; }
            
            container.innerHTML = items.map(item => {
                const stock = item.stock !== undefined ? item.stock : 50;
                const isAvailable = item.isAvailable && stock > 0; 
                const badge = item.isBestSeller ? `<div class="bestseller-badge">üî• Best Seller</div>` : '';
                
                let btnText = 'ADD +';
                if (!item.isAvailable) btnText = 'CLOSED';
                else if (stock <= 0) btnText = 'SOLD OUT';

                return `
                <div class="food-card ${!isAvailable ? 'sold-out' : ''}">
                    ${badge} <img src="${item.image}" class="food-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/754/754857.png'">
                    <div class="food-info">
                        <span class="food-cat">${item.category}</span>
                        <div class="food-name">${item.name}</div>
                        <div class="food-footer">
                            <span class="price">‚Çπ${item.price} <small style="font-size:10px; color:${stock < 5 ? 'red' : 'green'};">(${stock} left)</small></span>
                            <button class="add-btn" onclick="addToCart('${item._id}')">${btnText}</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function checkShopStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                isShopOpen = data.isOpen;

                const payBtn = document.getElementById('payBtn');
                const modal = document.getElementById('paymentModal');
                
                if(!isShopOpen) {
                    if(payBtn) {
                        payBtn.innerHTML = "STORE CLOSED üîí";
                        payBtn.style.background = "#7f8c8d"; 
                        payBtn.disabled = true;
                        payBtn.style.boxShadow = "none";
                    }
                    if(modal && modal.style.display === 'flex') {
                        modal.style.display = 'none';
                        showClosedMessage();
                    }
                } else {
                    if(payBtn) {
                        payBtn.innerHTML = 'PROCEED TO PAY <i class="fa-solid fa-arrow-right"></i>';
                        payBtn.style.background = "var(--primary)";
                        payBtn.disabled = false;
                        payBtn.style.boxShadow = "0 10px 25px rgba(15, 185, 177, 0.3)";
                    }
                }
            } catch(e) {}
        }

        function showClosedMessage() {
            Swal.fire({
                icon: 'warning',
                title: 'Store is Closed üò¥',
                text: 'We are currently offline. Please check back later! üëã',
                confirmButtonColor: '#0fb9b1',
                confirmButtonText: 'Okay!'
            });
        }

        function addToCart(id) {
            if(!isShopOpen) return showClosedMessage();
            
            const item = menuItems.find(i => i._id === id);
            const stock = item.stock !== undefined ? item.stock : 50;
            const currentQty = cart[id] ? cart[id].qty : 0;

            if (currentQty >= stock) {
                return Swal.fire("Out of Stock", `Only ${stock} left!`, "warning");
            }

            if(!cart[id]) cart[id] = { qty: 0, pack: false };
            cart[id].qty++; updateCartUI();
            
            const x = document.getElementById("toast"); 
            x.innerText="Item Added"; x.className="show"; 
            setTimeout(()=>{ x.className=""; }, 1500);
        }
        
        function updateQty(id, change) { 
            if(cart[id]) { 
                const item = menuItems.find(i => i._id === id);
                const stock = item.stock !== undefined ? item.stock : 50;

                if (change > 0 && cart[id].qty >= stock) {
                    return Swal.fire("Limit Reached", `Only ${stock} available.`, "warning");
                }

                cart[id].qty += change; 
                if(cart[id].qty <= 0) delete cart[id]; 
                updateCartUI(); 
            } 
        }
        
        function togglePack(id) { if(cart[id]) { cart[id].pack = !cart[id].pack; updateCartUI(); } }

        function updateCartUI() {
            const list = document.getElementById('cart-items-list');
            let subTotal = 0; let count = 0;
            list.innerHTML = Object.keys(cart).length === 0 ? '<div style="text-align:center; margin-top:50px; opacity:0.5;"><p>Cart is Empty</p></div>' : '';
            
            Object.keys(cart).forEach(id => {
                const item = menuItems.find(i => i._id === id);
                if(!item) return;

                subTotal += (item.price * cart[id].qty); count += cart[id].qty;
                list.innerHTML += `
                <div class="cart-item">
                    <div class="cart-item-top"><div>${item.name}</div><div>‚Çπ${item.price * cart[id].qty}</div></div>
                    <div class="item-actions">
                        <label class="pack-switch">
                            <input type="checkbox" class="pack-checkbox" ${cart[id].pack ? 'checked' : ''} onchange="togglePack('${id}')">
                            <div class="toggle-box"></div><span>${cart[id].pack ? 'Packed' : 'Standard'}</span>
                        </label>
                        <div class="qty-controls">
                            <span class="qty-btn" onclick="updateQty('${id}', -1)">-</span>
                            <span>${cart[id].qty}</span>
                            <span class="qty-btn" onclick="updateQty('${id}', 1)">+</span>
                        </div>
                    </div>
                </div>`;
            });

            document.getElementById('sub-total').innerText = subTotal;
            document.getElementById('final-total').innerText = subTotal;
            document.getElementById('pay-amount').innerText = subTotal;
            document.getElementById('cart-count').innerText = count;
            document.querySelector('.badge').style.display = count > 0 ? 'flex' : 'none';
            document.querySelector('.badge').innerText = count;
            currentTotal = subTotal;
        }

        const overlay = document.getElementById('overlay');
        function openSidebar(type) {
            overlay.classList.add('active');
            if(type==='cart') { 
                document.getElementById('cartSidebar').classList.add('active'); 
                document.getElementById('historySidebar').classList.remove('active'); 
            } else { 
                document.getElementById('historySidebar').classList.add('active'); 
                document.getElementById('cartSidebar').classList.remove('active'); 
                renderHistory();
            }
        }
        function closeAllSidebars() {
            document.getElementById('cartSidebar').classList.remove('active');
            document.getElementById('historySidebar').classList.remove('active');
            overlay.classList.remove('active');
        }

        async function openPayment() {
            await checkShopStatus();
            if(!isShopOpen) return showClosedMessage(); 
            if(currentTotal == 0) return Swal.fire('Cart Empty', 'Add items first! üõçÔ∏è', 'question');
            
            document.getElementById('student-name').value = localStorage.getItem('savedName') || '';
            document.getElementById('student-phone').value = localStorage.getItem('savedPhone') || '';
            document.getElementById('delivery-location').value = localStorage.getItem('savedLocation') || '';
            
            appliedCoupon = null; discountAmount = 0;
            document.getElementById('coupon-code').value = "";
            document.getElementById('coupon-msg').style.display = "none";
            document.getElementById('pay-amount').innerText = currentTotal;
            selectPaymentMode('COD');

            window.finalOrderTime = selectedTime === 'Schedule' ? "Schedule: " + document.getElementById('custom-time').value : selectedTime;
            closeAllSidebars(); document.getElementById('paymentModal').style.display='flex';
        }

        function selectPaymentMode(mode) {
            paymentMode = mode;
            document.getElementById('tab-cod').classList.remove('active');
            document.getElementById('tab-online').classList.remove('active');
            
            if(mode === 'Online') {
                document.getElementById('tab-online').classList.add('active');
                document.getElementById('qr-section').style.display = 'block';
                
                const finalAmt = appliedCoupon ? (currentTotal - discountAmount) : currentTotal;
                const upiLink = `upi://pay?pa=jainsambhav877@oksbi&pn=FreshMart&am=${finalAmt}&cu=INR`;
                document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(upiLink)}`;
                document.getElementById('qr-amt').innerText = finalAmt;
            } else {
                document.getElementById('tab-cod').classList.add('active');
                document.getElementById('qr-section').style.display = 'none';
            }
        }

        async function applyCoupon() {
            const code = document.getElementById('coupon-code').value.trim();
            if(!code) return;
            
            const btn = document.querySelector('.apply-btn');
            const msg = document.getElementById('coupon-msg');
            btn.innerHTML = "...";
            
            try {
                const res = await fetch('/api/verify-coupon', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code, total: currentTotal })
                });
                const data = await res.json();
                
                if(data.success) {
                    appliedCoupon = data.code;
                    discountAmount = data.discount;
                    msg.style.display = "block";
                    msg.style.color = "green";
                    msg.innerHTML = `‚úÖ <b>${data.code}</b> Applied! Saved ‚Çπ${data.discount}`;
                    document.getElementById('pay-amount').innerText = data.newTotal;
                    
                    if(paymentMode === 'Online') selectPaymentMode('Online'); 
                } else {
                    msg.style.display = "block";
                    msg.style.color = "red";
                    msg.innerText = "‚ùå " + data.message;
                    appliedCoupon = null; discountAmount = 0;
                    document.getElementById('pay-amount').innerText = currentTotal;
                }
            } catch(e) { console.log(e); }
            btn.innerHTML = "Apply";
        }

        function getGPSLocation() {
            const btn = document.getElementById('gps-btn');
            if (navigator.geolocation) {
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const long = position.coords.longitude;
                    const link = `http://googleusercontent.com/maps.google.com/maps?q=${lat},${long}`;
                    
                    document.getElementById('delivery-location').value = link;
                    
                    btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                    btn.style.background = "#e0fbfb";
                }, () => {
                    Swal.fire("Error", "Permission denied.", "error");
                    btn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>';
                });
            } else {
                Swal.fire("Error", "GPS not supported.", "error");
            }
        }

        async function verifyAndOrder() {
            const name = document.getElementById('student-name').value;
            const phone = document.getElementById('student-phone').value;
            const locationVal = document.getElementById('delivery-location').value;

            if(!name) return Swal.fire('Name?', 'Please enter your name!', 'question');
            if(!locationVal) return Swal.fire('Location?', 'Delivery location required!', 'question');

            const finalItems = Object.keys(cart).map(id => {
                const item = menuItems.find(i => i._id == id);
                return { id: id, name: cart[id].pack ? `${item.name} (üì¶)` : item.name, qty: cart[id].qty, price: item.price };
            });

            const finalPayable = appliedCoupon ? (currentTotal - discountAmount) : currentTotal;

            try {
                const res = await fetch('/api/order', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        name, phone: phone || "999", items: finalItems, 
                        total: currentTotal, finalTotal: finalPayable, 
                        mode: "Mixed", pickupTime: window.finalOrderTime, 
                        paymentId: 'Pay at Counter', deviceId: 'web', location: locationVal,
                        paymentMode: paymentMode,
                        coupon: appliedCoupon,
                        discount: discountAmount
                    })
                });
                
                const data = await res.json();
                
                if(data.success) {
                    localStorage.setItem('savedName', name); localStorage.setItem('savedPhone', phone); localStorage.setItem('savedLocation', locationVal);
                    document.getElementById('paymentModal').style.display = 'none';
                    Swal.fire({ icon: 'success', title: 'Order Placed! üéâ', text: `Order ID: #${data.orderId}`, timer: 4000 });
                    
                    saveLocalHistory({ orderId: data.orderId, items: finalItems, total: finalPayable, date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
                    cart = {}; updateCartUI(); fetchMenu(); setTimeout(() => openSidebar('history'), 1000);
                } else {
                    document.getElementById('paymentModal').style.display = 'none';
                    if(data.message === "Shop Closed") showClosedMessage(); else Swal.fire('Oops!', data.message, 'error');
                }
            } catch(e) { 
                document.getElementById('paymentModal').style.display = 'none'; Swal.fire('Network Error', 'Check Internet', 'error'); 
            }
        }

        function saveLocalHistory(order) {
            let history = JSON.parse(localStorage.getItem('my_store_orders')) || [];
            history.unshift(order);
            if(history.length > 15) history.pop();
            localStorage.setItem('my_store_orders', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const history = JSON.parse(localStorage.getItem('my_store_orders')) || [];

            if(history.length === 0) {
                list.innerHTML = '<div style="text-align:center; margin-top:50px; opacity:0.5;">No past orders</div>';
                return;
            }

            list.innerHTML = "";
            history.forEach(o => {
                list.innerHTML += `
                <div class="track-card status-Pending" style="border-left: 4px solid #0fb9b1; margin-bottom:10px; padding:12px; background:white; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.03);">
                    <div style="display:flex; justify-content:space-between; font-weight:700; margin-bottom:5px; font-size:14px;">
                        <span>#${o.orderId}</span> 
                        <span style="font-size:11px; background:#f1f2f6; padding:3px 8px; border-radius:6px; color:#636e72;">${o.date}</span>
                    </div>
                    <div style="font-size:13px; color:#636e72; line-height:1.4;">
                        ${o.items.map(i=>`${i.qty} x ${i.name.replace('(üì¶)','üì¶')}`).join('<br>')}
                    </div>
                    <div style="font-size:14px; font-weight:800; margin-top:8px; color:var(--dark); text-align:right;">
                        Total: ‚Çπ${o.total}
                    </div>
                </div>`;
            });
        }

        function filterCat(cat) { 
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderMenu(cat==='All' ? menuItems : menuItems.filter(i=>i.category===cat)); 
        }
        function filterMenu(val) { renderMenu(menuItems.filter(i=>i.name.toLowerCase().includes(val.toLowerCase()))); }
        function selectTime(el, time) {
            document.querySelectorAll('.time-chip').forEach(c => c.classList.remove('active')); el.classList.add('active');
            document.getElementById('custom-time').style.display = time === 'Schedule' ? 'block' : 'none';
            selectedTime = time;
        }
    </script>
</body>
</html>
