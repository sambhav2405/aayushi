<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Er's Cafe - Fast Bites</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e74c3c">
    <link rel="apple-touch-icon" href="logo.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* --- CORE STYLES --- */
        :root { --primary: #e74c3c; --dark: #2d3436; --light: #f5f6fa; --white: #ffffff; --green: #2ecc71; --blue: #0984e3; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--light); color: var(--dark); padding-bottom: 100px; overflow-x: hidden; }

        /* HEADER */
        header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); padding: 10px 5%; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .version-tag { font-family: 'Courier Prime', monospace; font-size: 10px; background: #ffebee; color: var(--primary); padding: 3px 6px; border-radius: 4px; border: 1px solid rgba(231, 76, 60, 0.2); margin-left: 5px; }
        
        .nav-icons { display: flex; gap: 15px; align-items: center; }
        .icon-btn { font-size: 24px; color: var(--dark); cursor: pointer; position: relative; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; }
        .icon-btn:active { transform: scale(0.95); background: #eee; }
        .badge { position: absolute; top: 4px; right: 4px; background: var(--primary); color: white; font-size: 10px; height: 16px; min-width: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; border: 2px solid white; display: none; }

        /* HERO */
        .hero { background: linear-gradient(135deg, #ff7675, #d63031); padding: 25px 20px; border-radius: 0 0 30px 30px; color: white; text-align: center; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(214, 48, 49, 0.25); }
        .hero h1 { font-size: 28px; font-weight: 800; margin-bottom: 5px; letter-spacing: -0.5px; }
        .hero p { font-size: 14px; opacity: 0.95; font-weight: 400; }

        /* PWA BANNER */
        .app-banner { 
            margin: 0 5% 20px 5%; 
            background: linear-gradient(45deg, #2d3436, #000000); 
            padding: 15px; 
            border-radius: 15px; 
            color: white; 
            display: none; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); 
            border: 1px solid #444; 
            animation: slideDown 0.5s ease;
        }
        @keyframes slideDown { from{transform: translateY(-20px); opacity: 0;} to{transform: translateY(0); opacity: 1;} }
        .app-btn { background: #2ecc71; color: white; text-decoration: none; padding: 8px 16px; border-radius: 20px; font-weight: 800; font-size: 12px; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); transition: 0.2s; border:none; cursor: pointer; }
        .app-btn:active { transform: scale(0.95); }

        /* CONTROLS */
        .controls { padding: 0 5%; margin-bottom: 20px; }
        .search-box { width: 100%; padding: 14px 20px; border: none; border-radius: 15px; font-size: 16px; margin-bottom: 15px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); font-weight: 600; outline: none; transition: 0.3s; color: var(--dark); }
        .search-box:focus { box-shadow: 0 5px 20px rgba(231, 76, 60, 0.15); }
        .filters { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .filter-btn { white-space: nowrap; padding: 10px 18px; border: none; background: white; border-radius: 25px; cursor: pointer; font-weight: 700; color: #636e72; box-shadow: 0 3px 10px rgba(0,0,0,0.05); transition: 0.3s; font-size: 13px; border: 1px solid transparent; }
        .filter-btn.active { background: var(--primary); color: white; transform: scale(1.05); box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3); }

        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 18px; padding: 0 5%; }
        .food-card { background: white; border-radius: 18px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.03); transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border: 1px solid rgba(0,0,0,0.02); position: relative; }
        .food-card:active { transform: scale(0.96); }
        .food-card.sold-out { opacity: 0.6; filter: grayscale(1); pointer-events: none; }
        .food-card.sold-out::after { content: "SOLD OUT"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); background: var(--dark); color: white; padding: 6px 12px; font-weight: 800; border-radius: 6px; font-size: 13px; z-index: 2; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .food-img { width: 100%; height: 130px; object-fit: cover; }
        .food-info { padding: 15px; }
        .food-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .food-cat { font-size: 11px; color: #b2bec3; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .food-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        .price { font-size: 18px; font-weight: 800; color: var(--dark); }
        .add-btn { background: white; border: 2px solid var(--primary); color: var(--primary); padding: 6px 14px; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .add-btn:active { background: var(--primary); color: white; }

        /* SIDEBAR SYSTEM */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 998; display: none; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s; }
        .overlay.active { display: block; opacity: 1; }
        .sidebar { position: fixed; top: 0; width: 85%; max-width: 400px; height: 100%; background: white; z-index: 1000; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; box-shadow: 0 0 40px rgba(0,0,0,0.2); }
        .history-sidebar { left: 0; transform: translateX(-105%); }
        .history-sidebar.active { transform: translateX(0); }
        .cart-sidebar { right: 0; transform: translateX(105%); }
        .cart-sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 20px 25px; background: white; display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: 800; border-bottom: 1px solid #f1f2f6; color: var(--dark); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; }

        /* CART */
        .cart-item { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid #fff; }
        .cart-item-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: 700; font-size: 15px; }
        .item-actions { display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; padding: 5px; border-radius: 10px; border: 1px solid #f1f2f6; }
        .pack-switch { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; cursor: pointer; user-select: none; }
        .toggle-box { width: 36px; height: 20px; background: #dfe6e9; border-radius: 20px; position: relative; transition: 0.3s; }
        .toggle-box::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .pack-checkbox:checked + .toggle-box { background: var(--primary); }
        .pack-checkbox:checked + .toggle-box::after { left: 18px; }
        .pack-checkbox { display: none; }
        .qty-controls { display: flex; align-items: center; gap: 12px; background: white; padding: 5px 12px; border-radius: 10px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .qty-btn { font-weight: 800; color: var(--primary); cursor: pointer; font-size: 16px; width: 20px; text-align: center; }

        .cart-footer { padding: 25px; background: white; border-top: 1px solid #f1f2f6; border-radius: 20px 20px 0 0; box-shadow: 0 -10px 30px rgba(0,0,0,0.03); z-index: 10; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; font-weight: 500; color: #636e72; }
        .total-row { display: flex; justify-content: space-between; font-size: 20px; font-weight: 800; color: var(--dark); margin-top: 15px; padding-top: 15px; border-top: 2px dashed #f1f2f6; }
        .checkout-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: 800; cursor: pointer; margin-top: 20px; box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3); transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .checkout-btn:active { transform: scale(0.98); }
        .checkout-btn:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; }

        .time-chips { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 5px; scrollbar-width: none; }
        .time-chip { padding: 10px 16px; border-radius: 12px; background: #f1f2f6; font-weight: 700; font-size: 13px; color: var(--dark); cursor: pointer; border: 2px solid transparent; white-space: nowrap; transition: 0.2s; }
        .time-chip.active { background: #ffebee; border-color: var(--primary); color: var(--primary); }

        .track-card { background: white; padding: 18px; margin-bottom: 15px; border-radius: 15px; border-left: 6px solid #dfe6e9; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .track-header { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 8px; font-size: 15px; }
        .track-items { font-size: 13px; color: #636e72; margin-bottom: 10px; line-height: 1.5; }
        .track-status { font-size: 11px; padding: 5px 10px; border-radius: 20px; font-weight: 800; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .status-Pending { border-left-color: #f1c40f; } .status-Pending .track-status { background: #fff9db; color: #f39c12; }
        .status-Accepted { border-left-color: #3498db; } .status-Accepted .track-status { background: #e3f2fd; color: #2980b9; } 
        .status-Ready { border-left-color: #2ecc71; } .status-Ready .track-status { background: #e8f5e9; color: #27ae60; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 5000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 25px; width: 85%; max-width: 360px; text-align: center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        input { width: 100%; padding: 14px; margin-bottom: 12px; border: 2px solid #f1f2f6; border-radius: 12px; font-weight: 600; background: #f9f9f9; outline: none; font-size: 15px; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: white; }

        #toast { visibility: hidden; min-width: 250px; background: #2d3436; color: #fff; text-align: center; border-radius: 50px; padding: 14px; position: fixed; z-index: 6000; left: 50%; transform: translateX(-50%); bottom: 30px; font-size: 14px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.0s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* BADGE */
        .bestseller-badge { position: absolute; top: 10px; left: 10px; background: rgba(255, 71, 87, 0.85); backdrop-filter: blur(4px); color: white; font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10; border: 1px solid rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 0.5px; }

        /* üî• FIX Z-INDEX */
        div:where(.swal2-container) { z-index: 10000 !important; }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="closeAllSidebars()"></div>

    <header>
        <div class="logo">
            <img src="logo.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/754/754857.png'" alt="Er's Cafe" style="height: 55px; width: auto; margin-right: 5px;"> 
            ER'S CAFE <span class="version-tag">v5.0</span>
        </div>
        <div class="nav-icons">
            <div class="icon-btn" onclick="openSidebar('history')" title="Track Orders"><i class="fa-solid fa-clock-rotate-left"></i></div>
            <a href="admin.html" style="text-decoration:none; color:var(--dark); font-size:12px; font-weight:700; background:#f1f2f6; padding:6px 12px; border-radius:20px;">ADMIN</a>
            <div class="icon-btn" onclick="openSidebar('cart')">
                <i class="fa-solid fa-bag-shopping"></i>
                <span class="badge" id="cart-count">0</span>
            </div>
        </div>
    </header>

    <section class="hero">
        <h1>Tasty Food üçî</h1>
        <p>ER'S CAFE - SKIT Jaipur</p>
    </section>

    <div class="app-banner" id="installBanner">
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="logo.png" style="height:40px; border-radius:10px; background:white;">
            <div>
                <div style="font-weight: 800; font-size: 14px;">Install App üì≤</div>
                <div style="font-size: 11px; opacity: 0.8;">Better Experience</div>
            </div>
        </div>
        <button class="app-btn" id="installBtn">INSTALL</button>
    </div>

    <section class="controls">
        <input type="text" class="search-box" placeholder="üîç Search Pizza, Maggi..." onkeyup="filterMenu(this.value)">
        <div class="filters">
            <button class="filter-btn active" onclick="filterCat('All')">All</button>
            <button class="filter-btn" onclick="filterCat('Burger')">Burger</button>
            <button class="filter-btn" onclick="filterCat('Pizza')">Pizza</button>
            <button class="filter-btn" onclick="filterCat('Maggi')">Maggi</button>
            <button class="filter-btn" onclick="filterCat('Sandwich')">Sandwich</button>
            <button class="filter-btn" onclick="filterCat('Chinese')">Chinese</button>
            <button class="filter-btn" onclick="filterCat('Rolls')">Rolls</button>
            <button class="filter-btn" onclick="filterCat('Patties')">Patties</button>
            <button class="filter-btn" onclick="filterCat('Momos')">Momos</button>
            <button class="filter-btn" onclick="filterCat('Pasta')">Pasta</button>
            <button class="filter-btn" onclick="filterCat('Snacks')">Snacks</button>
            <button class="filter-btn" onclick="filterCat('Drinks')">Drinks</button>
        </div>
    </section>

    <section class="menu-grid" id="menu-container"></section>

    <div class="sidebar history-sidebar" id="historySidebar">
        <div class="sidebar-header">
            <span>üìú Track Orders</span> 
            <i class="fa-solid fa-xmark" onclick="closeAllSidebars()" style="cursor:pointer; background:#f1f2f6; padding:8px; border-radius:50%;"></i>
        </div>
        <div class="sidebar-content" id="history-list">
            <div style="text-align:center; margin-top:50px; opacity:0.5;">No active orders</div>
        </div>
    </div>

    <div class="sidebar cart-sidebar" id="cartSidebar">
        <div class="sidebar-header">
            <span>üõí My Cart</span> 
            <i class="fa-solid fa-xmark" onclick="closeAllSidebars()" style="cursor:pointer; background:#f1f2f6; padding:8px; border-radius:50%;"></i>
        </div>
        <div class="sidebar-content" id="cart-items-list">
            <div style="text-align:center; margin-top:50px; opacity:0.5;"><p>Cart is Empty</p></div>
        </div>
        <div class="cart-footer">
            <div class="time-chips" id="time-chips">
                <div class="time-chip active" onclick="selectTime(this, 'ASAP')">‚ö° ASAP</div>
                <div class="time-chip" onclick="selectTime(this, '15 Mins')">15 Min</div>
                <div class="time-chip" onclick="selectTime(this, '30 Mins')">30 Min</div>
                <div class="time-chip" onclick="selectTime(this, 'Schedule')">üìÖ Plan</div>
            </div>
            <input type="time" id="custom-time" style="display:none; margin-bottom:15px; width:100%; border:1px solid #ddd; padding:10px; border-radius:10px;">

            <div class="bill-row"><span>Total</span> <span>‚Çπ<span id="sub-total">0</span></span></div>
            <div class="total-row"><span>To Pay</span> <span>‚Çπ<span id="final-total">0</span></span></div>
            <button class="checkout-btn" id="payBtn" onclick="openPayment()">PROCEED TO PAY <i class="fa-solid fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:5px;">Total: ‚Çπ<span id="pay-amount">0</span></h2>
            <div style="background:#e8f5e9; color:#27ae60; padding:12px; border-radius:12px; margin-bottom:20px; font-weight:700; border:1px solid #27ae60; font-size:13px;">
                üëã Payment ‡§≠‡•à‡§Ø‡§æ ‡§ï‡•ã ‡§ï‡§æ‡§â‡§Ç‡§ü‡§∞ ‡§™‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§
            </div>
            <input type="text" id="student-name" placeholder="Enter Your Name">
            <input type="tel" id="student-phone" placeholder="Mobile Number">
           <label style="font-size:12px; font-weight:bold; color:#555; margin-top:10px; display:block;">Delivery Location:</label>
<div style="display:flex; gap:8px; margin-bottom:15px;">
    <input type="text" id="delivery-location" placeholder="Eg: GIVE LOCATION" style="margin-bottom:0; flex:1;">
    
    <button onclick="getGPSLocation()" id="gps-btn" style="width:50px; background:#e3f2fd; color:#0984e3; border:1px solid #0984e3; border-radius:12px; cursor:pointer; font-size:18px;">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>
</div>
            <div style="display:flex; gap:12px; margin-top:10px;">
                <button onclick="document.getElementById('paymentModal').style.display='none'" style="flex:1; padding:14px; background:#f1f2f6; border:none; border-radius:12px; font-weight:bold; cursor:pointer; color:#636e72;">Cancel</button>
                <button onclick="verifyAndOrder()" style="flex:1; padding:14px; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toast">Item Added</div>

 <script>
        // --- üî• PWA LOGIC (Install Banner) ---
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); 
            deferredPrompt = e; 
            installBanner.style.display = 'flex'; 
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt(); 
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') { installBanner.style.display = 'none'; }
                deferredPrompt = null;
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch((err) => console.log('SW Failed', err));
        }

        // --- MENU & CART LOGIC ---
        let menuItems = []; 
        let cart = {};
        let isShopOpen = true;
        let selectedTime = "ASAP";

        window.onload = async () => {
            await fetchMenu(); // Load Menu from DB
            checkShopStatus(); // Check Status immediately
            
            // üî• LOAD PRE-FILLED DATA & HISTORY (FROM LOCAL STORAGE)
            if(localStorage.getItem('savedName')) {
                document.getElementById('student-name').value = localStorage.getItem('savedName');
            }
            if(localStorage.getItem('savedPhone')) {
                document.getElementById('student-phone').value = localStorage.getItem('savedPhone');
            }
            renderHistory(); // Show History from Local Storage

            // üî• AUTO-CHECK SHOP STATUS EVERY 3 SECONDS
            setInterval(checkShopStatus, 3000);
        };

        // --- üî• 1. FETCH MENU FROM DB ---
        async function fetchMenu() {
            try {
                const res = await fetch('/api/menu');
                menuItems = await res.json();
                renderMenu(menuItems);
            } catch(e) { console.log("Menu Load Error"); }
        }

        function renderMenu(items) {
            const container = document.getElementById('menu-container');
            if(items.length === 0) { container.innerHTML = "<p style='text-align:center;width:100%; color:#888;'>Loading Menu...</p>"; return; }
            
            container.innerHTML = items.map(item => {
                const isAvailable = item.isAvailable; 
                const badge = item.isBestSeller ? `<div class="bestseller-badge">üî• Best Seller</div>` : '';
                return `
                <div class="food-card ${!isAvailable ? 'sold-out' : ''}">
                    ${badge} <img src="${item.image}" class="food-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/754/754857.png'">
                    <div class="food-info">
                        <span class="food-cat">${item.category}</span>
                        <div class="food-name">${item.name}</div>
                        <div class="food-footer">
                            <span class="price">‚Çπ${item.price}</span>
                            <button class="add-btn" onclick="addToCart('${item._id}')">${isAvailable ? 'ADD +' : 'SOLD'}</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- üî• 2. ROBUST SHOP STATUS CHECKER ---
        async function checkShopStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                isShopOpen = data.isOpen;

                const payBtn = document.getElementById('payBtn');
                const modal = document.getElementById('paymentModal');
                
                if(!isShopOpen) {
                    if(payBtn) {
                        payBtn.innerHTML = "SHOP CLOSED üîí";
                        payBtn.style.background = "#7f8c8d"; 
                        payBtn.disabled = true;
                        payBtn.style.boxShadow = "none";
                    }
                    if(modal && modal.style.display === 'flex') {
                        modal.style.display = 'none';
                        showClosedMessage();
                    }
                } else {
                    if(payBtn) {
                        payBtn.innerHTML = 'PROCEED TO PAY <i class="fa-solid fa-arrow-right"></i>';
                        payBtn.style.background = "var(--primary)";
                        payBtn.disabled = false;
                        payBtn.style.boxShadow = "0 10px 25px rgba(231, 76, 60, 0.3)";
                    }
                }
            } catch(e) {}
        }

        function showClosedMessage() {
            Swal.fire({
                icon: 'warning',
                title: 'Shop is Closed üò¥',
                text: '‡§Æ‡§æ‡§´‡§º ‡§ï‡•Ä‡§ú‡§ø‡§Ø‡•á! ‡§Ö‡§≠‡•Ä ‡§Ü‡§∞‡•ç‡§°‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•á ‡§∏‡§ï‡§§‡•á‡•§ ‡§π‡§Æ ‡§∏‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç, ‡§ï‡§≤ ‡§Æ‡§ø‡§≤‡•á‡§Ç‡§ó‡•á! üëã',
                confirmButtonColor: '#e74c3c',
                confirmButtonText: 'Okay, See You!'
            });
        }

        function addToCart(id) {
            if(!isShopOpen) return showClosedMessage();
            if(!cart[id]) cart[id] = { qty: 0, pack: false };
            cart[id].qty++; updateCartUI();
            
            const x = document.getElementById("toast"); 
            x.innerText="Item Added"; x.className="show"; 
            setTimeout(()=>{ x.className=""; }, 1500);
        }
        
        function updateQty(id, change) { 
            if(cart[id]) { 
                cart[id].qty += change; 
                if(cart[id].qty <= 0) delete cart[id]; 
                updateCartUI(); 
            } 
        }
        
        function togglePack(id) { if(cart[id]) { cart[id].pack = !cart[id].pack; updateCartUI(); } }

        function updateCartUI() {
            const list = document.getElementById('cart-items-list');
            let subTotal = 0; let count = 0;
            list.innerHTML = Object.keys(cart).length === 0 ? '<div style="text-align:center; margin-top:50px; opacity:0.5;"><p>Cart is Empty</p></div>' : '';
            
            Object.keys(cart).forEach(id => {
                const item = menuItems.find(i => i._id === id); // Find by _id from DB
                if(!item) return;

                subTotal += (item.price * cart[id].qty); count += cart[id].qty;
                list.innerHTML += `
                <div class="cart-item">
                    <div class="cart-item-top"><div>${item.name}</div><div>‚Çπ${item.price * cart[id].qty}</div></div>
                    <div class="item-actions">
                        <label class="pack-switch">
                            <input type="checkbox" class="pack-checkbox" ${cart[id].pack ? 'checked' : ''} onchange="togglePack('${id}')">
                            <div class="toggle-box"></div><span>${cart[id].pack ? 'Takeaway' : 'Dine-in'}</span>
                        </label>
                        <div class="qty-controls">
                            <span class="qty-btn" onclick="updateQty('${id}', -1)">-</span>
                            <span>${cart[id].qty}</span>
                            <span class="qty-btn" onclick="updateQty('${id}', 1)">+</span>
                        </div>
                    </div>
                </div>`;
            });

            document.getElementById('sub-total').innerText = subTotal;
            document.getElementById('final-total').innerText = subTotal;
            document.getElementById('pay-amount').innerText = subTotal;
            document.getElementById('cart-count').innerText = count;
            document.querySelector('.badge').style.display = count > 0 ? 'flex' : 'none';
            document.querySelector('.badge').innerText = count;
        }

        // SIDEBAR UTILS
        const overlay = document.getElementById('overlay');
        function openSidebar(type) {
            overlay.classList.add('active');
            if(type==='cart') { 
                document.getElementById('cartSidebar').classList.add('active'); 
                document.getElementById('historySidebar').classList.remove('active'); 
            } else { 
                document.getElementById('historySidebar').classList.add('active'); 
                document.getElementById('cartSidebar').classList.remove('active'); 
                renderHistory(); // Refresh History
            }
        }
        function closeAllSidebars() {
            document.getElementById('cartSidebar').classList.remove('active');
            document.getElementById('historySidebar').classList.remove('active');
            overlay.classList.remove('active');
        }

        // PAYMENT FLOW
      async function openPayment() {
    await checkShopStatus();
    if(!isShopOpen) return showClosedMessage(); 
    if(document.getElementById('final-total').innerText == 0) return Swal.fire('Cart Empty', 'Add items first! üçî', 'question');
    
    // Auto-Fill Data from Local Storage
    document.getElementById('student-name').value = localStorage.getItem('savedName') || '';
    document.getElementById('student-phone').value = localStorage.getItem('savedPhone') || '';
    
    // üî• NEW: Last Saved Location Auto-Fill
    document.getElementById('delivery-location').value = localStorage.getItem('savedLocation') || '';
    
    // GPS Button Reset
    document.getElementById('gps-btn').innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>';
    document.getElementById('gps-btn').style.background = "#e3f2fd";

    window.finalOrderTime = selectedTime === 'Schedule' ? "Schedule: " + document.getElementById('custom-time').value : selectedTime;
    closeAllSidebars(); 
    document.getElementById('paymentModal').style.display='flex';
}
// --- üìç GPS LOCATION LOGIC ---
function getGPSLocation() {
    const btn = document.getElementById('gps-btn');
    if (navigator.geolocation) {
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; // Loading icon
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const long = position.coords.longitude;
            // Google Maps Link In Input Box
            const link = `http://maps.google.com/maps?q=${lat},${long}`;
            
            document.getElementById('delivery-location').value = link; // üî• Input me link daal diya
            
            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
            btn.style.background = "#e8f5e9";
        }, () => {
            Swal.fire("Error", "Location permission denied.", "error");
            btn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>';
        });
    } else {
        Swal.fire("Error", "GPS not supported.", "error");
    }
}

function showPosition(position) {
    const lat = position.coords.latitude;
    const long = position.coords.longitude;
    // Google Maps Link Create
    const link = `https://www.google.com/maps?q=${lat},${long}`;
    
    document.getElementById('location-link').value = link;
    
    // UI Update
    const btn = document.getElementById('loc-btn');
    btn.style.background = "#e8f5e9";
    btn.style.color = "#27ae60";
    btn.style.borderColor = "#27ae60";
    btn.innerHTML = '<i class="fa-solid fa-check"></i> Location Attached!';
}

function showError(error) {
    const btn = document.getElementById('loc-btn');
    btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Permission Denied';
    Swal.fire("Location Error", "Please allow location access.", "warning");
}
      async function verifyAndOrder() {
    const name = document.getElementById('student-name').value;
    const phone = document.getElementById('student-phone').value;
    // üî• New: Location Input se value uthana
    const locationVal = document.getElementById('delivery-location').value;

    if(!name) return Swal.fire('Naam?', 'Naam likhna zaruri hai! üòÖ', 'question');
    if(!locationVal) return Swal.fire('Location?', 'Kahan deliver karna hai? (Room No. ya GPS)', 'question');

    const finalItems = Object.keys(cart).map(id => {
        const item = menuItems.find(i => i._id == id);
        return { name: cart[id].pack ? `${item.name} (üì¶ PACKED)` : item.name, qty: cart[id].qty, price: item.price };
    });
    
    const total = document.getElementById('final-total').innerText;
    const deviceId = localStorage.getItem('canteen_device_id') || 'unknown'; 

    try {
        const res = await fetch('/api/order', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                name, phone: phone || "999", items: finalItems, total, finalTotal: total, 
                mode: "Mixed", pickupTime: window.finalOrderTime, paymentId: 'Pay at Counter', deviceId,
                location: locationVal // üî• Ye User ki current location jayegi
            })
        });
        
        const data = await res.json();
        
        if(data.success) {
            // üî• SAVE NEW DATA TO LOCAL STORAGE
            localStorage.setItem('savedName', name); 
            localStorage.setItem('savedPhone', phone);
            localStorage.setItem('savedLocation', locationVal); // New Location Save ho gayi

            document.getElementById('paymentModal').style.display = 'none';
            Swal.fire({ icon: 'success', title: 'Order Placed! üéâ', text: `Order ID: #${data.orderId}`, timer: 4000 });
            
            // Save History Logic (Same as before)
            const myOrder = { orderId: data.orderId, items: finalItems, total: total, date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), status: 'Pending' };
            saveLocalHistory(myOrder);

            cart = {}; updateCartUI(); 
            setTimeout(() => openSidebar('history'), 1000);
        } else {
            document.getElementById('paymentModal').style.display = 'none';
            if(data.message === "Shop Closed") showClosedMessage(); else Swal.fire('Oops!', data.message, 'error');
        }
    } catch(e) { 
        document.getElementById('paymentModal').style.display = 'none';
        Swal.fire('Network Error', 'Internet check karo! üì∂', 'error'); 
    }
}

        // --- üî• LOCAL STORAGE HISTORY LOGIC ---
        function saveLocalHistory(order) {
            let history = JSON.parse(localStorage.getItem('my_canteen_orders')) || [];
            history.unshift(order);
            if(history.length > 15) history.pop(); // Keep last 15 orders
            localStorage.setItem('my_canteen_orders', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const history = JSON.parse(localStorage.getItem('my_canteen_orders')) || [];

            if(history.length === 0) {
                list.innerHTML = '<div style="text-align:center; margin-top:50px; opacity:0.5;">No past orders</div>';
                return;
            }

            list.innerHTML = "";
            history.forEach(o => {
                let statusColor = '#f39c12';
                // Note: Local storage status is static "Pending" unless we implement complex syncing.
                // For basic history, showing the order details is enough.
                
                list.innerHTML += `
                <div class="track-card status-Pending" style="border-left: 4px solid ${statusColor}; margin-bottom:10px; padding:12px; background:white; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.03);">
                    <div style="display:flex; justify-content:space-between; font-weight:700; margin-bottom:5px; font-size:14px;">
                        <span>#${o.orderId}</span> 
                        <span style="font-size:11px; background:#f1f2f6; padding:3px 8px; border-radius:6px; color:#636e72;">${o.date}, ${o.time}</span>
                    </div>
                    <div style="font-size:13px; color:#636e72; line-height:1.4;">
                        ${o.items.map(i=>`${i.qty} x ${i.name.replace('(üì¶ PACKED)','üì¶')}`).join('<br>')}
                    </div>
                    <div style="font-size:14px; font-weight:800; margin-top:8px; color:var(--dark); text-align:right;">
                        Total: ‚Çπ${o.total}
                    </div>
                </div>`;
            });
        }

        function filterCat(cat) { 
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderMenu(cat==='All' ? menuItems : menuItems.filter(i=>i.category===cat)); 
        }
        function filterMenu(val) { renderMenu(menuItems.filter(i=>i.name.toLowerCase().includes(val.toLowerCase()))); }
        function selectTime(el, time) {
            document.querySelectorAll('.time-chip').forEach(c => c.classList.remove('active')); el.classList.add('active');
            document.getElementById('custom-time').style.display = time === 'Schedule' ? 'block' : 'none';
            selectedTime = time;
        }
    </script>
</body>
</html>
